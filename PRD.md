# Product Requirements Document (PRD): AlgoRave IDLE (MVP)

**Document Version:** 0.2 (Updated for AI Consumption)
**Date:** May 26, 2025
**Product Name:** AlgoRave IDLE

---

### 1. Introduction

AlgoRave IDLE is an incremental idle game. The core gameplay involves players generating "Beats" through a simulated livecoding environment. These Beats are used to unlock and upgrade "Code Modules" (samples, synths, effects) and "Hardware" (RAM, CPU, DSP, Storage). A unique aspect is the real-time audio output generated by `strudel.cc`, reflecting the player's progress and active modules. The game should foster a sense of continuous progression, allow for idle play, and immerse the player in a thematic blend of livecoding culture, incremental game mechanics, and a touch of humorous meta-commentary.

**Project Status:** Initial React/Vite/Tailwind setup complete. Core game loop logic for `Beats` generation, module/hardware purchasing, and state management is implemented within `src/context/GameContext.tsx`. Strudel.cc packages are installed. The UI components are built to consume the game state.

---

### 2. Goals & Objectives (Current Focus: MVP Validation)

*   **Primary Goal:** Achieve a fully functional and rendering MVP that showcases the core idle loop, basic resource management, and **crucially, real-time audio output via `strudel.cc`**.
*   **Key Objectives for Prototype Validation:**
    1.  **Resolve all runtime errors:** Specifically, the `escodegen` module export error.
    2.  **Ensure UI renders correctly:** The game dashboard should be visible and interactive.
    3.  **Verify core `Beat` generation:** Clicking should add beats, and purchased modules should generate BPS.
    4.  **Verify `strudel.cc` audio playback:** Toggling the "Start/Stop AlgoRave" button should initiate/halt audio output from `strudel.cc` reflecting the current `strudelCode` string.
    5.  **Confirm basic module/hardware purchases:** Players can buy the initial "bd" module and "RAM/CPU" upgrades.
    6.  **Validate News Feed functionality:** News items appear for purchases and game events.
    7.  **Validate Achievement tracking:** Basic achievements like "First Beat" should unlock.

---

### 3. Target Audience

*   Idle/Incremental game enthusiasts (familiar with concepts like prestige, automation, exponential growth).
*   Individuals interested in coding, electronic music production, livecoding, or AlgoRaves.
*   Players who appreciate deep optimization and emergent system interactions.

---

### 4. Core Gameplay Loop (MVP)

1.  **Initial Action:** Player clicks "Tap Beat" button to manually generate `Beats`.
2.  **First Automation:** Player purchases the "Kick Drum (bd)" module, which automates `Beats per Second (BPS)` generation.
3.  **Resource Spending:** Players spend `Beats` to unlock and upgrade:
    *   **Code Modules:** More `Samples`, `Synths`, `Effects`.
    *   **Hardware:** Increased `RAM`, `CPU Cores`, `DSP Units`, `Storage`.
4.  **Optimization:** Modules consume `Hardware` resources. Players must manage `Hardware` capacity to avoid penalties to `BPS`.
5.  **Audio Feedback:** The `strudel.cc` engine constantly plays music reflecting the active "Code Modules" and `strudelCode` in the `GameState`.
6.  **Progress Indicators:** `Beats` and `BPS` count up, News Feed updates, Achievements unlock.

---

### 5. Key Mechanics & Features (MVP Scope, Detailed)

#### 5.1. Core Progression & Resources

*   **`Beats` (Primary Currency):**
    *   **Generation:**
        *   Manual clicks: `addBeats(1)` on "Tap Beat" button.
        *   Automated: `bps` calculated from `modules` and `hardware` capabilities, added in game loop `deltaTime`.
    *   **Consumption:** Spent on `Modules` and `Hardware`.
*   **`Code Snippets` (Modules):**
    *   **Types:** `sample`, `synth`, `effect`, `refactor`. (Defined in `src/types.ts`, data in `src/data/modules.ts`).
    *   **Properties:** `id`, `name`, `type`, `baseCost` (Beats), `bpsPerUnit` (Beats), `acquiredCount`, `description`, `unlocked` (boolean).
    *   **Resource Consumption (`consumption` object):** `ram` (MB), `cpu` (cores), `dsp` (units), `storage` (GB).
    *   **`unlocked` Logic:** Initial `bd` module is `unlocked: true` at start. Other modules unlock based on current `beats` and `acquiredCount` of prerequisite modules (e.g., `sn` unlocks after `bd` count > 0 and `beats` > 20).
*   **Hardware Resources (`Hardware` and `HardwareCapacity` types):**
    *   **Types:** `ram`, `cpu`, `dsp`, `storage`. (Defined in `src/types.ts`, data in `src/data/hardware.ts`).
    *   **Properties:** `id`, `name`, `type`, `baseCost` (Beats), `capacity` (value), `acquiredCount`, `description`, `unlocked` (boolean).
    *   **`GameState.hardware`:** Stores `total` and `used` capacity for each type.
    *   **Consumption:** Modules consume `used` hardware.
    *   **Overload Penalty:** If `used` > `total` for any hardware type, `BPS` is reduced by 50% for each overloaded type. News message is generated.
    *   **`unlockedHardwareTypes`:** Array in `GameState` indicating which *types* of hardware are available for purchase. Initially `['ram', 'cpu']`. `dsp` type unlocks when `sine_synth` module is acquired. `storage` type unlocks after certain beat threshold.

#### 5.2. `strudel.cc` Integration

*   **Objective:** Play algorithmic music based on activated game modules.
*   **Mechanism:** `useStrudelEngine` hook in `src/hooks/useStrudelEngine.ts` uses `@strudel/core`, `@strudel/mini`, `@strudel/transpiler`, `@strudel/webaudio`.
*   **User Interaction:** Audio must be initiated by a user gesture (e.g., clicking the "Start AlgoRave" button). The `useStrudelEngine` handles `AudioContext.resume()`.
*   **`strudelCode` Generation:** `GameContext.tsx` builds a string `gameState.strudelCode` based on `acquiredCount` of modules.
    *   **Rule:** Each active module (acquiredCount > 0) should add a line to the `strudelCode`. For MVP, a simple `d[trackNumber] $ sound "[module.id]"` for samples and `d[trackNumber] $ synth "[synth.id.replace('_synth', '')]"` for synths.
    *   **Default:** If no modules are active, `strudelCode` defaults to `d1 $ sound "bd"`.
*   **`strudelBPM`:** A fixed `120` BPM for MVP.

#### 5.3. News Feed

*   **Location:** `src/components/NewsFeed.tsx`.
*   **Mechanism:** `gameState.newsFeed` is an array of `NewsItem` objects.
*   **Content:** Messages for module/hardware purchases, unlock events, hardware overloads. Max 10 items displayed.
*   **Updates:** `addNews` function (memoized in `GameContext`) adds new items.

#### 5.4. Achievements System

*   **Location:** `src/components/AchievementsDisplay.tsx`.
*   **Definitions:** `src/data/achievements.ts` defines `ALL_ACHIEVEMENTS` with `id`, `name`, `description`, `unlocked` (boolean), `hidden` (boolean), and a `condition` function `(gameState: GameState) => boolean`.
*   **Tracking:** `checkAchievements` function in `GameContext` `useEffect` loop periodically checks all conditions against `gameState` and updates `unlocked` status.
*   **Display:** Categorize achievements by unlocked/visible locked/hidden.

#### 5.5. User Interface (UI) / User Experience (UX)

*   **Layout:** Defined in `src/App.tsx` (3 columns: Left (Clicker, Beats, Strudel), Middle (Module/Hardware Shops), Right (News, Achievements)).
*   **Styling:** Tailwind CSS (`index.css`, `App.css`, component-specific Tailwind classes). Utilizes Shadcn-UI button patterns (`src/components/ui/button.tsx`).
*   **Information Display:** Clear, real-time updates for `Beats`, `BPS`, hardware usage.
*   **Interactivity:** Buttons for clicker, module/hardware purchases, Strudel play/stop.
*   **Tooltips:** Module/Hardware buttons should have tooltips explaining why they are disabled (cost, hardware capacity).

---

### 6. Technical Stack & File Structure

*   **Frontend Framework:** React (TSX)
*   **Build Tool/Bundler:** Vite
*   **Styling:** Tailwind CSS (configured with `@tailwindcss/vite` plugin).
*   **Type Safety:** TypeScript.
*   **Core Libraries:**
    *   `@strudel/core`, `@strudel/mini`, `@strudel/transpiler`, `@strudel/webaudio` for audio.
    *   `class-variance-authority`, `clsx`, `tailwind-merge` for UI utilities.
*   **File Structure:**
    ```
    src/
    ├── App.css
    ├── App.tsx
    ├── assets/
    ├── components/
    │   ├── ui/
    │   │   └── button.tsx
    │   ├── AchievementsDisplay.tsx
    │   ├── BeatDisplay.tsx
    │   ├── Clicker.tsx
    │   ├── HardwareShop.tsx
    │   ├── ModuleShop.tsx
    │   ├── NewsFeed.tsx
    │   └── StrudelOutput.tsx
    ├── context/
    │   └── GameContext.tsx
    ├── data/
    │   ├── achievements.ts
    │   ├── hardware.ts
    │   └── modules.ts
    ├── hooks/
    │   └── useStrudelEngine.ts
    ├── lib/
    │   └── utils.ts
    ├── main.tsx
    └── types.ts  # IMPORTANT: This file is now directly in `src/`, not `src/types/`
    ```
*   **`vite.config.ts`:** Explicitly excludes Strudel packages and `escodegen` from `optimizeDeps` due to module resolution issues.

---
### 7. Known Issues & Remaining Fixes for MVP Validation

*   **CRITICAL: `escodegen` Module Export Error:**
    *   **Symptom:** `Uncaught SyntaxError: The requested module '.../escodegen.js' doesn't provide an export named: 'default'` in browser console.
    *   **Root Cause (Hypothesized):** Vite's dependency pre-bundling misinterprets `escodegen`'s exports.
    *   **Attempted Fixes:** Added `escodegen` to `optimizeDeps.exclude` in `vite.config.ts`. A full clean/reinstall was performed. **This issue needs to be resolved for the app to render.**
*   **`src/types.ts` Import Confusion:**
    *   **Symptom:** Browser serving a truncated `types.ts` file (missing interfaces) when the game loads, despite correct file content on disk. Console error `No matching export ... for import "Module"`.
    *   **Root Cause (Hypothesized):** Stubborn browser/Vite cache after file moves, or an internal Vite issue with how it transforms TS files containing *only* types/interfaces (which don't have runtime exports).
    *   **Attempted Fixes:** Moved `types.ts` to `src/`, aggressive cache clears, `npm install`, removed debugging type imports from `main.tsx`. **This seems to be fixed from the `main.tsx` perspective, but the truncated file serving is still an indicator of underlying caching/bundling weirdness.** The priority is that the *app* uses the correct interfaces at compile time and runs without runtime errors from this file.
*   **UI Not Rendering (White Screen):** Direct result of the `escodegen` error. Once `escodegen` is resolved, the UI should appear.

---

### 8. Future Considerations (Beyond MVP)

*   Detailed `n` variant implementation for samples.
*   Complex synth and effect routing/patching.
*   Audience simulation with dynamic effects on `BPS` and unlocks.
*   Prestige system (`Rewire Reality`) and `AIP` spending.
*   Mid-game "Custom Rig Builder" and late-game "Server Farms" with their own management challenges (cooling, power).
*   Gigs and Collectives meta-game.
*   Save/Load functionality (local storage).
*   Audio visualizer tied to Strudel output.
*   Refinement of unlock conditions and progression balance.
*   More diverse news feed messages and random events.
*   "Glitch/Bug Farm" mechanics.
*   Jazz/NuJazz vibes and Jungle/Breakcore rhythm emphasis in Strudel patterns.

---