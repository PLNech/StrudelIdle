# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Development Commands

### Build & Development
- **Start development server**: `npm run dev`
- **Build for production**: `npm run build` (runs TypeScript compilation then Vite build)
- **Preview production build**: `npm run preview`
- **Clearing vite cache**: `rm -rf node_modules/.vite`

### Code Quality
- **Lint code**: `npm run lint` (ESLint with strict TypeScript rules)
- **Auto-fix lint issues**: `npm run lint:fix`
- **Format code**: `npm run format` (Prettier)

## Project Architecture

This is **AlgoRave IDLE**, an incremental idle game where players generate "Beats" to unlock code modules and hardware upgrades, with real-time audio output via Strudel.cc.

### Core Architecture Pattern
The game follows a **React Context + Hook pattern** with a central game loop:

1. **GameContext** (`src/context/GameContext.tsx`) - Central state management with game loop running on `requestAnimationFrame`
2. **Type Definitions** (`src/types.ts`) - All TypeScript interfaces for game entities
3. **Data Definitions** (`src/data/`) - Static game data for modules, hardware, achievements
4. **Components** (`src/components/`) - UI components that consume game state
5. **Strudel Integration** (`src/hooks/useStrudelEngine.ts`) - Real-time audio engine

### Key Game Systems

#### Resource Management
- **Beats**: Primary currency, generated by clicking and module automation
- **BPS (Beats Per Second)**: Calculated from owned modules with hardware capacity constraints
- **Hardware Capacity**: RAM/CPU/DSP/Storage limiting module deployment
- **Modules**: Code samples/synths/effects that generate BPS and consume hardware

#### State Flow
1. Game loop in `GameContext` calculates BPS based on active modules
2. Hardware consumption is checked and overload penalties applied
3. Strudel code string is generated from active modules
4. UI components reactively display current state
5. User actions (clicks, purchases) update state via context methods

#### Strudel.cc Audio Engine
- **Hook**: `useStrudelEngine` manages WebAudio context and pattern evaluation
- **Code Generation**: Active modules automatically generate Strudel patterns (`d1 $ sound "bd"`)
- **User Gesture Requirement**: Audio must be initiated by user interaction (Start/Stop button)

### Important Technical Details

#### Vite Configuration
- Strudel packages and `escodegen` are excluded from Vite's dependency pre-bundling (`vite.config.ts`)
- This resolves module import issues with the Strudel.cc libraries

#### Type Safety
- All game entities are strictly typed in `src/types.ts`
- Game state mutations use immutable updates via React setState patterns
- Context provides typed methods for state updates (`addBeats`, `purchaseModule`, etc.)

#### Performance Considerations
- Game loop runs on `requestAnimationFrame` for smooth 60fps updates
- State updates are batched and memoized to prevent unnecessary re-renders
- News feed is limited to 10 items to prevent memory growth

### Module System
Modules are defined in `src/data/modules.ts` with:
- **Type classification**: sample, synth, effect, refactor
- **Resource consumption**: RAM/CPU/DSP/Storage per unit
- **BPS generation**: Beats per second contribution
- **Unlock conditions**: Dynamic unlocking based on game progression

### Common Development Patterns

#### Adding New Modules
1. Define module object in `src/data/modules.ts`
2. Add unlock condition in `GameContext.tsx` game loop
3. Update Strudel code generation logic for new module types

#### Hardware Management
- Hardware items are purchased to increase capacity (`total`)
- Modules consume capacity (`used`) when acquired
- Overload conditions (used > total) apply BPS penalties

#### Achievement System
- Defined in `src/data/achievements.ts` with condition functions
- Checked every game loop iteration against current `GameState`
- Automatically unlock and trigger news feed updates
